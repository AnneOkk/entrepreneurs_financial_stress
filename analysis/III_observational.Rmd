---
title: "III_observational"
author: "Anne"
date: "12/20/2021"
output: html_document
---

# III Observational

## Preparation

```{r include=TRUE}
library(stringr)
library(zoo)
library(lubridate)
library(sjlabelled)

# rename columns T1 

names(observational_finstrain) <- paste0("T1",names(observational_finstrain))
names(observational_finstrain) <- gsub("quit1_1", "quitint_1", names(observational_finstrain))
names(observational_finstrain) <- gsub("quit2_1", "quitint_2", names(observational_finstrain))
names(observational_finstrain) <- gsub("quit2_2", "quitint_3", names(observational_finstrain))
names(observational_finstrain) <- gsub("(PANA)_([6-9]|10)", "PA_\\2", names(observational_finstrain))
names(observational_finstrain) <- gsub("(PANA_)([1-5])", "NA_\\2", names(observational_finstrain))

names(observational_finstrain_T2) <- gsub("quit_1_1", "quitint_1", names(observational_finstrain_T2))
names(observational_finstrain_T2) <- gsub("quit_2_1", "quitint_2", names(observational_finstrain_T2))
names(observational_finstrain_T2) <- gsub("quit_2_2", "quitint_3", names(observational_finstrain_T2))

obs_df <- left_join(observational_finstrain, observational_finstrain_T2, by = c("T1PROLIFIC_PID" = "PROLIFIC_PID"))

# recode columns
obs_df <- obs_df %>% 
  dplyr::mutate_at(vars(dplyr::matches(c("employable_2", "affcom_1", "affcom_2"))), ~ (.*(-1)+6)) %>% 
  dplyr::mutate(T2_jobsat_1 =  T2_jobsat_1*(-1)+7)


# remove test data
obs_df <- subset(obs_df, nchar(as.character(obs_df$T1PROLIFIC_PID)) >= 15) %>% drop_na(T1occ)

# make age 
obs_df$T1age_1 <- as.numeric(names(attr(obs_df$T1age_1,"labels")[match(obs_df$T1age_1,attr(obs_df$T1age_1,"labels"))]))


# make time since business foundation
timediff <- function() {
  year_n <- as.numeric(names(attr(obs_df$T1year_1,"labels")[match(obs_df$T1year_1,attr(obs_df$T1year_1,"labels"))]))
  month_n <- as.numeric(obs_df$T1month_1 %>% remove_all_labels(.))
  time <- as.yearmon(paste(year_n, month_n), "%Y %m") %>% as_date(.)
  record <- as.yearmon(obs_df$T1RecordedDate, "%Y %m") %>% as_date(.)
  difftime <- difftime(record, time, UTC,
         units = c("days"))
  return(difftime)
}

obs_df$T1timebuiss <- timediff()


# deselect not important columns
obs_df <- obs_df  %>%
dplyr::select(-dplyr::matches("Always|bye|group|Status|IPAddress|Progress|Duration|Finished|ResponseId|
                                                         LastName|FirstName|entEmail|Reference|Latitude|Longitude|Channel|UserLang|
                                                         Consent|Q28"))

# Replace occ status
obs_df <- obs_df %>% remove_all_labels(.) %>%
     mutate(T1occ = case_when(T1occ_3_TEXT=="Business owner but main role is home maker|Business owner and student|Student with business
                            |student business owner|self employed and carer for my daughter|Self-employed and student"~ 2,
                            TRUE ~ T1occ))

# check for duplicates
obs_df <- obs_df[!(duplicated(obs_df$T1PROLIFIC_PID)), ]

# basis sample (no filters)
obs_df<- obs_df %>% drop_na(T1occ)
cat("Number of participants in the original dataset:", nrow(obs_df), "\n")

# remove not entrepreneur
obs_df <- obs_df[!(obs_df$T1occ ==3), ]
cat("Number of participants after occupational status is not entrepreneur removed:", nrow(obs_df) , "\n")


# delete not involved in founding
obs_df <- obs_df[!(obs_df$T1found ==2), ]
cat("Number of participants after not involved in founding removed:", nrow(obs_df), "\n")


# Attention checks T1
## create attention fails df 
attention_fail <- function() {
  attention_f <- obs_df[(obs_df$T1chal_3 != 4) | (obs_df$T1threat_4 != 4) | (obs_df$T1satis_4 != 2),]
  ID_vals <- data.frame(table(attention_f$T1ID))
  Rows_fails <- attention_f$T1ID %in% ID_vals[ID_vals$Freq > 0,1]
  Att_fails <- attention_f[Rows_fails,]
  return(Att_fails)
}

Att_fails <- attention_fail() # 8 excluded

## exclude attention fails (one or more fails)
t1 <- obs_df %>% dplyr::select(-dplyr::matches("T2_")) %>% drop_na(T1occ) %>% .[!(.$T1ID %in% Att_fails$T1ID),] %>% dplyr::select(-T1chal_3,-T1threat_4,-T1satis_4)

cat("Number of T1 attention fails (at least one of three attention check items failed):", nrow(Att_fails) , "\n")
cat("Number of participants after T1 attention fails removed:", nrow(t1) , "\n")

# Number of T2 participants
t2 <- obs_df[!(is.na(obs_df$T2_PID)), ] %>% select(matches("T2_"))

cat("Number of T2 participants:", nrow(t2), "\n")

# Quit between last survey and now
t2 <- t2[!(t2$T2_quit == 2), ]
cat("Number of T2 participants after excluding those who quit their business between May 2021 and now (Dec 2021): ", nrow(t2), "\n")

### Attention checks T2
## create attention fails df 
attention_fail <- function() {
  attention_f <- t2[(t2$T2_lifesat_4 != 2) | (t2$T2_vita_5 != 3) | (t2$T2_entresat_4 != 6),]
  ID_vals <- data.frame(table(attention_f$T2_PID))
  Rows_fails <- attention_f$T2_PID %in% ID_vals[ID_vals$Freq > 0,1]
  Att_fails <- attention_f[Rows_fails,]
  return(Att_fails)
}

Att_fails <- attention_fail() 

## exclude attention fails (one or more fails)
t2<- t2 %>% .[!(.$T2_PID %in% Att_fails$T2_PID),] %>% dplyr::select(-T2_lifesat_4 ,-T2_vita_5, -T2_entresat_4)

cat("Number of T2 attention fails (at least one of three attention check items failed):", nrow(Att_fails) , "\n")
cat("Number of participants after T2 attention fails removed:", nrow(t2) , "\n")


# join the two attention checked data frames 
obs_df <- left_join(t1, t2, by = c("T1PROLIFIC_PID" = "T2_PID"))

cat("Final sample size T1: ", nrow(obs_df), "\n")
cat("Final sample size T2: ", nrow(t2), "\n")


names(obs_df) <- gsub("T2_", "T2", names(obs_df))


```

```{r}
library(multicon)
library(sjlabelled)
library(data.table)

comp_dat <- obs_df %>%
  dplyr::select(dplyr::matches("cope_1|cope_2|cope_3|emocope|finstrain_\\d$|chal|threat|satis|quitint|^NA|^PA|employable|affcom|concom|lifesat|vita|normcom|entresat|jobsat")) %>% remove_all_labels(.) %>% .[, !sapply(., is.character)]

demo_dat <- obs_df %>%
  dplyr::select(dplyr::matches("occ|employees|coown|indu|locat|age_1|gender|lang|edu|timeb|quitfinstrain|T2currententre|T2quit")) %>% dplyr::select(-dplyr::matches("TEXT")) %>% remove_all_labels(.)

demo_dat$T1timebuiss <- as.numeric(demo_dat$T1timebuiss)

alph_dat <- comp_dat

comp_split <- comp_dat %>%
  split.default(sub("_.*", "", names(comp_dat))) 

alph_split <- alph_dat %>%
  split.default(sub("_.*", "", names(alph_dat))) 

comp <- purrr::map(comp_split, ~ multicon::composite(.x, nomiss = 0.8), data = .x) %>% as.data.frame(.)
alph <- purrr::map(alph_split, ~ psych::alpha(.x), data = .x) %>%
  purrr::map(~ .x$total)

# add demos
comp_df <- cbind(comp, demo_dat) %>% .[, !sapply(., is.character)]

alph_df <- do.call("rbind", alph) %>% round(., 2)
```

## Reliabilities 

```{r include = TRUE}
alph_df %>%
DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv"),
                   pageLength = 15))
```

## Correlations

```{r include = TRUE}
cor <- round(cor(comp_df, use="pairwise.complete.obs"), 2)

library(kableExtra)

corstar_select <- data.frame(corstars(comp_df, removeTriangle = "none", result="none"))

corstar_select %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv"),
                   pageLength = 15,
                  lengthMenu = c(25, 50, 75, 94)))
```


## Factor structure

### Three factors commitment

```{r include = T}
library(lavaan)
com_FA <- "
T1concom =~ T1concom_1 + T1concom_2 + T1concom_3
T1affcom =~ T1affcom_1 + T1affcom_2 + T1affcom_3
T2normcom =~ T2normcom_1 + T2normcom_2 + T2normcom_3
"

fit <- cfa(com_FA , data=obs_df)
summary(fit, fit.measures=TRUE)
```

### Modification indices > 9

```{r include = T}
modificationindices(fit) %>%
  as_data_frame() %>%
  arrange(-mi) %>%
  filter(mi > 9) %>%
  select(lhs, op, rhs, mi, epc) %>%
  pander(caption="MI values > 9 for commitment FA")
```

### Comparison to continuance and affective combined 

```{r include = T}
com2_FA <- "
T1concom =~ T1concom_1 + T1concom_2 + T1concom_3 + T1affcom_1 + T1affcom_2 + T1affcom_3
T2normcom =~ T2normcom_1 + T2normcom_2 + T2normcom_3
"
fit2 <- cfa(com2_FA , data=obs_df)
anova(fit, fit2)
```

### Comparison to continuance and normative combined 

```{r include = T}
com3_FA <- "
T1concom =~ T1concom_1 + T1concom_2 + T1concom_3 + T2normcom_1 + T2normcom_2 + T2normcom_3
T1affcom =~ T1affcom_1 + T1affcom_2 + T1affcom_3
"
fit3 <- cfa(com3_FA , data=obs_df)
anova(fit, fit3)
```


### Comparison to affective and normative combined 

```{r include = T}
com4_FA <- "
T1concom =~ T1concom_1 + T1concom_2 + T1concom_3
T1affcom =~ T1affcom_1 + T1affcom_2 + T1affcom_3 + T2normcom_1 + T2normcom_2 + T2normcom_3
"
fit4 <- cfa(com4_FA , data=obs_df)
anova(fit, fit4)
```

## Hypotheses tests quit intention 

### Cross-sectional

```{r}
library(lavaan)
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T1quitint", controls = F, fullfit = TRUE)
```


#### T1 finstrain > T1 con. commitment > T1 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
library(lavaan)
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T1quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)

```

##### Detailed output

```{r include = T}
library(lavaan)
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T1quitint", controls = F)
```


#### T1 finstrain > T1 con. commitment > T1 quit {.tabset .tabset-fade}

* with control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T1quitint", controls = T, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T1quitint", controls = T)
```


#### T1 finstrain > T1 aff. commitment > T1 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T1quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T1quitint", controls = F)
```

#### T1 finstrain > T1 aff. commitment > T1 quit {.tabset .tabset-fade}

* with control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T1quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T1quitint", controls = F)
```

### Lagged 

#### T1 finstrain > T1 con. commitment > T2 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2quitint", controls = F, fullfit = F) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2quitint", controls = F) 
```

* with control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2quitint", controls = T, fullfit = F) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2quitint", controls = T) 
```

* with control variables and T1 control        
                         
```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2quitint", controls = T, fullfit = TRUE, T1control = T, T1controlvar = "T1quitint") 
```

#### T1 finstrain > T1 aff. commitment > T2 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2quitint", controls = F)
```

* with control variables and T1 control        
                         
```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2quitint", controls = T, fullfit = TRUE, T1control = T, T1controlvar = "T1quitint") 
```

### Cross-sectional 

#### T2 finstrain > T2 norm. commitment > T2 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T2finstrain",  mediator = "T2normcom", DV = "T2quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T2finstrain",  mediator = "T2normcom", DV = "T2quitint", controls = F)
```

### Lagged 

#### T1 finstrain > T2 con. commitment > T2 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T2concom", DV = "T2quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T2concom", DV = "T2quitint", controls = F)
```

* with control variables and T1 control

##### Detailed output


```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T2concom", DV = "T2quitint", controls = F, fullfit = TRUE, T1control = TRUE, T1controlmediator = TRUE, T1controlmediatorvar  = "T1concom")
```



#### T1 finstrain > T2 aff. commitment > T2 quit {.tabset .tabset-fade}

* without control variables

##### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T2affcom", DV = "T2quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T2affcom", DV = "T2quitint", controls = F)
```

* with control variables and T1 control

##### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T2affcom", DV = "T2quitint", controls = F, fullfit = TRUE, T1control = FALSE, T1controlmediator = TRUE, T1controlmediatorvar  = "T1affcom")
```


## Hypotheses tests DV: entrepreneurial satisfaction

### T1 finstrain > T1 con. commitment > T2 entre sat {.tabset .tabset-fade}

* without control variables

#### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2entresat", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

#### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2entresat", controls = F)
```

### T1 finstrain > T1 aff. commitment > T2 entre sat {.tabset .tabset-fade}

#### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2entresat", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

#### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2entresat", controls = F)
```

## DV: Job satisfaction

### T1 finstrain > T1 con. commitment > T2 job sat {.tabset .tabset-fade}

#### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2jobsat", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

#### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1concom", DV = "T2jobsat", controls = F)
```

### T1 finstrain > T1 aff. commitment > T2 job sat {.tabset .tabset-fade}

#### Indirect effect

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2entresat", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

#### Detailed output

```{r include = T}
model_lavaan(IV = "T1finstrain",  mediator = "T1affcom", DV = "T2entresat", controls = F)
```

## Multigroup analysis normative 

* employees yes = 2 or no = 1

### T2 finstrain > T2 normcom > T2 quit {.tabset .tabset-fade}

#### Indirect effect

```{r include = T}
model_lavaan_multigroup(IV = "T2finstrain",  mediator = "T2concom", DV = "T2quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

#### Detailed output

```{r include = T}
model_lavaan_multigroup(IV = "T2finstrain",  mediator = "T2concom", DV = "T2quitint", controls = F)
```

## Multiple mediators

### T1 finstrain > T1concom (m1), T1affcom (m2) > T2 quit {.tabset .tabset-fade}

#### Indirect effect

```{r include = T}
model_lavaan_multimed (IV = "T1finstrain",  mediator1 = "T1concom", mediator2 = "T1affcom", DV = "T2quitint", controls = F, fullfit = FALSE) %>% 
  kable(., digits = 3, row.names = FALSE)
```

#### Detailed output

```{r include = T}
model_lavaan_multimed (IV = "T1finstrain",  mediator1 = "T1concom", mediator2 = "T1affcom", DV = "T2quitint", controls = T)
```

### T1 finstrain > T1concom (m1), T1affcom (m2) > T2 entresa {.tabset .tabset-fade}

#### Indirect effect

```{r include = T}
model_lavaan_multimed (IV = "T1finstrain",  mediator1 = "T1concom", mediator2 = "T1affcom", DV = "T2entresat", controls = F, fullfit = TRUE) 

```





