---
title: "II_psycorona"
author: "Anne"
date: "12/20/2021"
output: html_document
---

# II PsyCorona

## Preparation 

```{r include = TRUE}
# Rename
names(PsyCorona) <- gsub("PFS0", "fin_strain0", names(PsyCorona), fixed = TRUE)
df <- PsyCorona

library("dplyr")

df_e <- df %>% filter(!is.na(w4_employstatus_14))

df_e <-  df_e[!is.na(df_e$w5_SE_quit),] 

cat("Number of participants in the dataset:", nrow(df_e), "\n")

df_e$coded_country_text <- df_e$coded_country

## Get difference baseline w5

df_e$date_diff <- difftime(df_e$w5_StartDate, df_e$StartDate)

##Convert founding date

df_e$SE_start_recode <- as.numeric(names(attr(df_e$w5_SE_start,"labels")[match(df_e$w5_SE_start,attr(df_e$w5_SE_start,"labels"))]))
df_e$SE_start_recode <- 2020-df_e$SE_start_recode


# employees yes or no
df_e$w5_SE_employees_dich <- ifelse(df_e$w5_SE_employees_1 > 0, 1, 0)
```


```{r}
library(multicon)
names(df_e)

df_e$coded_country_fac <- factor(df_e$coded_country)
df_e$coded_country_num <- as.numeric(df_e$coded_country_fac)

comp_dat <- df_e %>%
  dplyr::select(probSolving01, probSolving02, probSolving03, fin_strain01, fin_strain02, fin_strain03) 

comp_singleitem <- df_e %>%
  dplyr::select(w5_SE_quit,w5_lifeSat, SE_start_recode, age, gender, edu, coded_country_num, w5_fin_strain01, w5_SE_employees_dich) 

alph_dat <- comp_dat

comp_split <- comp_dat %>%
  split.default(sub("0.*", "", names(comp_dat))) 

alph_split <- alph_dat %>%
  split.default(sub("0.*", "", names(alph_dat))) 

comp <- purrr::map(comp_split, ~ multicon::composite(.x, nomiss = 0.8), data = .x)
alph <- purrr::map(alph_split, ~ psych::alpha(.x), data = .x) %>%
  purrr::map(~ .x$total)

# add demos
comp_df <- as.data.frame(do.call("cbind", comp))
alph_df <- do.call("rbind", alph) %>% round(., 2)

```

## Reliabilities

```{r include = TRUE}
## Correlations and reliabilities 

alph_df %>%
DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv"),
                   pageLength = 15))
```

## Correlations

```{r include = TRUE}
df_e$w7_employstatus_11[is.na(df_e$w7_employstatus_11)] <- 0
df_e$w7_employstatus_12[is.na(df_e$w7_employstatus_12)] <- 0

df_e <- cbind(df_e, comp_df)

comp_df <- cbind(comp_df, comp_singleitem) %>% remove_all_labels(.)

#comp_df$date_diff <- as.numeric(comp_df$date_diff)

cor <- round(cor(comp_df, use="pairwise.complete.obs"), 2)

Mean <- round(colMeans(comp_df, na.rm =T),2)
SD <- round(apply(comp_df, 2, sd, na.rm =T),2)

mean_sd <- as.data.frame(rbind(Mean, SD)) %>% t()

library(dplyr)

corstar_select <- cbind(mean_sd, data.frame(corstars(comp_df, removeTriangle = "none", result="none")))  %>%
  dplyr::mutate(across(everything(), as.character))


corstar_select %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv"),
                   pageLength = 35,
                  lengthMenu = c(25, 50, 75, 94)))
```


```{r eval = FALSE}
## Make table 
rownames(corstar_select) <- c("1. Financial strain", "2. Problem-focused coping", "3. Quit intention", 
                              "4. Life satisfaction", "5. Founding date", "6. Age",
                              "7. Gender", "8. Education", "9. Country of origin")

colnames(corstar_select) <- c("Mean", "SD", "1.", "2.", "3.", 
                              "4.", "5.", "6.",
                              "7.", "8.")

library(xtable)
print(xtable(corstar_select, type = "latex"), file = "cor_comp_psycorona.tex")

## Sample characteristics
tabyl(comp_df$gender, sort = F)
names(comp_df)

tabyl(comp_df$age, sort = F)

tabyl(comp_df$coded_country_num, sort = F)
```


```{r eval = FALSE}
## Impute missing data 
names(df_e)
df_e_impute <- df_e %>% remove_all_labels(.) %>% select(matches("w5_SE_quit|w5_SE_employees_1|w5_lifeSat|w7_lifeSat|age|gender|edu|SE_start_recode|coded_country_num|T1probsolv_center|T1finstrain_center"))
library(mice)

imputed_Data <- mice(df_e_impute, m=5, maxit = 50, method = 'pmm', seed = 500)
summary(imputed_Data)

df_e_impute <- complete(imputed_Data,2)

```

## Hypotheses tests

## Potential moderators

* Employer status
* Business age 

### Cross-sectional

#### T2 finstrain > T2 quit 

* with control variables 

```{r include = TRUE}
model <- lm(w5_SE_quit ~ w5_fin_strain01 + w5_SE_employees_dich + SE_start_recode+  age + gender + edu + coded_country_num, data = df_e)
pander(summary(model))
```

#### T2 finstrain * employer status > T2 quit 

* with control variables 

```{r include = TRUE}
model <- lm(w5_SE_quit ~ w5_fin_strain01*w5_SE_employees_dich + SE_start_recode+  age + gender + edu + coded_country_num, data = df_e)
pander(summary(model))
```

#### T2 finstrain * business age > T2 quit 

* with control variables 

```{r include = TRUE}
model <- lm(w5_SE_quit ~ w5_fin_strain01*SE_start_recode + w5_SE_employees_dich +  age + gender + edu + coded_country_num, data = df_e)
pander(summary(model))
```

### Lagged

#### T1 finstrain > T2 quit 

* with control variables 

```{r include = TRUE}
model <- lm(w5_SE_quit ~ fin_strain + SE_start_recode + w5_SE_employees_dich +  age + gender + edu + coded_country_num, data = comp_df)
pander(summary(model))

names(comp_df)
```

#### T1 finstrain * employer status > T2 quit 

* with control variables 

```{r include = TRUE}
model <- lm(w5_SE_quit ~ fin_strain*w5_SE_employees_dich + SE_start_recode + age + gender + edu + coded_country_num, data = comp_df)
pander(summary(model))
```

#### T1 finstrain * business age > T2 quit 

* with control variables 

```{r include = TRUE}
model <- lm(w5_SE_quit ~ fin_strain*SE_start_recode + w5_SE_employees_dich +  age + gender + edu + coded_country_num, data = comp_df)
pander(summary(model))
```


