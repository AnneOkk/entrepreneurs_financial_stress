---
title: "IV_vignette"
author: "Anne"
date: "12/20/2021"
output: html_document
---

# I Vignette

## Preparation 


```{r include = TRUE}
# make location variable
Vignette_finstrain$locat <- (names(attr(Vignette_finstrain$locat,"labels")[match(Vignette_finstrain$locat,attr(Vignette_finstrain$locat,"labels"))]))

# only include those with valid ID 
Vignette_finstrain <- Vignette_finstrain[str_length(Vignette_finstrain$ID) > 19, ]

# assign experimental and control group 
Vignette_finstrain <- Vignette_finstrain %>% dplyr::mutate(exp_cond = ifelse(group == "control", 1,
                                             ifelse(group == "intervention", 2, NA)))

# drop non-valid data 
Vignette_finstrain <- Vignette_finstrain %>% drop_na(mani_1)
cat("Number of participants in the original dataset:", nrow(Vignette_finstrain), "\n")

## Remove non-founders
Vignette_finstrain<-Vignette_finstrain[!(Vignette_finstrain$found==2),]
cat("Number of participants after not involved in founding removed:", nrow(Vignette_finstrain), "\n")

### Attention checks
vignette_df_fails = Vignette_finstrain %>% dplyr::select(chal_4,threat_4,satis_4)

## create attention fails df 
att_1 <- Vignette_finstrain[Vignette_finstrain$chal_4 %in% c(1, 2, 3, 5), ]
att_2 <- Vignette_finstrain[Vignette_finstrain$threat_4 %in% c(1,2, 3, 5), ]
att_3 <- Vignette_finstrain[Vignette_finstrain$satis_4 %in% c(1, 3, 4, 5, 6, 7), ]

attention_fail <- rbind(att_1, att_2, att_3) %>%
  as_tibble(.)

ID_vals <- data.frame(table(attention_fail$ID))
Rows_fails <- attention_fail$ID %in% ID_vals[ID_vals$Freq > 0,1]
Att_fails <- attention_fail[Rows_fails,]

## exclude attention fails (two or more fails)
vignette_df <- Vignette_finstrain[!(Vignette_finstrain$ID %in% Att_fails$ID),]

cat("Number of T1 attention fails (at least one of three attention check items failed):", nrow(unique(Att_fails)) , "\n")
cat("Number of participants after T1 attention fails removed:", nrow(vignette_df) , "\n")

vignette_df <- vignette_df[, -which(names(vignette_df) %in% c("chal_4","threat_4", "satis_4"))]

```

```{r}
## Reliabilities 

library(multicon)
library("sjlabelled")
library(lubridate)
library(stringr)
library(zoo)
library(tidyverse)
vignette_df$year <- as.numeric(names(attr(vignette_df$year_1,"labels")[match(vignette_df$year_1,attr(vignette_df$year_1,"labels"))]))

vignette_df$age <- as.numeric(names(attr(vignette_df$age_1,"labels")[match(vignette_df$age_1,attr(vignette_df$age_1,"labels"))]))


vignette_df$month <- (names(attr(vignette_df$month_1,"labels")[match(vignette_df$month_1,attr(vignette_df$month_1,"labels"))]))


vignette_df$t1timebuiss <- as.yearmon(paste(vignette_df$year, vignette_df$month), "%Y %b")

vignette_df$t1timebuiss <- as_date(vignette_df$t1timebuiss)

vignette_df$RecordedDate <- as_date(vignette_df$RecordedDate)

vignette_df$quitting1 <- vignette_df$quit1_1


vignette_df$t1timebuiss <- as.numeric(difftime(vignette_df$RecordedDate, vignette_df$t1timebuiss, UTC,
         units = c("days")))

library("tidyverse")

comp_dat <-  vignette_df %>% dplyr::select(dplyr::matches("cope|mani|chal|threat|quit|satis|PANA")) %>% remove_all_labels(.) %>% dplyr::select(-quitting1) 

comp_dat <- comp_dat %>% dplyr::rename(quit_1 = quit1_1, 
                                       quit_2 = quit2_1,
                                       quit_3 = quit2_2,
                                       PA_5 = PANA_10,
                                       NA._1 = PANA_1,
                                       NA._2 = PANA_2,
                                       NA._3 = PANA_3,
                                       NA._4 = PANA_4,
                                       NA._5 = PANA_5,
                                       PA_1 = PANA_6,
                                       PA_2 = PANA_7,
                                       PA_3 = PANA_8,
                                       PA_4 = PANA_9) 


library(tidyr)

matches <- dplyr::matches


comp_dat_single_item <- vignette_df %>% dplyr::select(dplyr::matches("finsit|exp_cond|t1timebuiss|coown|indu|age|gender|lang|edu|quitting1|locat|quitting "))  %>% remove_all_labels(.) %>% dplyr::select(-matches("UserLanguage|Q52_Page_Submit|Q53_Page_Submit|_TEXT|ifelse|age_1|LocationLatitude|LocationLongitude")) 

  
alph_dat <- comp_dat

comp_split <- comp_dat %>%
  split.default(sub("_.*", "", names(comp_dat))) 

alph_split <- alph_dat %>%
  split.default(sub("_.*", "", names(alph_dat))) 

comp <- purrr::map(comp_split, ~ multicon::composite(.x, nomiss = 0.8), data = .x)
alph <- purrr::map(alph_split, ~ psych::alpha(.x), data = .x) %>%
  purrr::map(~ .x$total)

# add demos
comp_df_vig <- as.data.frame(do.call("cbind", comp)) %>% cbind(comp_dat_single_item)
alph_df_vig <- do.call("rbind", alph) %>% round(., 2)
```

## Reliabilities 

```{r include = TRUE}
alph_df_vig %>%
DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv"),
                   pageLength = 15))
```


```{r eval = FALSE}
## Impute missing data 
library(mice)

imputed_Data <- mice(comp_df_vig, m=5, maxit = 50, method = 'pmm', seed = 500)
summary(imputed_Data)

completeData <- complete(imputed_Data,2)
names(comp_df_vig)
```

## Correlations

```{r include = TRUE}
comp_df_vig = comp_df_vig %>% dplyr::select(-dplyr::matches("locat"))

corstar <- data.frame(corstars(comp_df_vig, removeTriangle = "none", result="none"))

## Make table 
comp_df_vig_corselect  <- comp_df_vig %>% select(exp_cond, cope, mani, NA., quit, satis, finsit_1, finsit_2, age, gender, edu)

Mean <- round(colMeans(comp_df_vig , na.rm =T),2)
SD <- round(apply(comp_df_vig , 2, sd, na.rm =T),2)

mean_sd <- as.data.frame(rbind(Mean, SD)) %>% t()

corstar_select <- cbind(mean_sd, data.frame(corstars(comp_df_vig, removeTriangle = "none", result="none")))  %>%
  dplyr::mutate(across(everything(), as.character))

corstar_select %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv"),
                   pageLength = 15,
                  lengthMenu = c(25, 50, 75, 94)))

  
#rownames(corstar_select) <- c("1. Financial strain", "2. Problem-focused coping", "3. Quit intention", 
#                              "4. Life satisfaction", "5. Founding date", "6. Age",
#                              "7. Gender", "8. Education", "9. Country of origin")

#colnames(corstar_select) <- c("Mean", "SD", "1.", "2.", "3.", 
#                              "4.", "5.", "6.",
#                              "7.", "8.")

#(xtable)
#print(xtable(corstar_select, type = "latex"), file = "cor_comp_psycorona.tex")

#comp_df$w5_SE_quit

#names(comp_df_vig_corselect)

## get list of participants for blocklist

#paste0( vignette_df$ID, collapse=",")

## Recode coping measurement
comp_df_vig <- comp_df_vig %>% mutate(cope = cope-5)
```

## Potential moderators

* Cognitive appraisal (challenge and threat)
* Coping style (problem- and emotion-focused)
* Coownership
* Business age 

## Hypothesis tests

* First, we test the direct effect of perceived financial strain on entrepreneurs' intention to quit. 

### Fin. strain > Quit intention 

* with control variables

```{r include = TRUE}
model2 <- lm(quit ~  exp_cond + t1timebuiss + finsit_1 + finsit_2 + age + gender + edu, data = comp_df_vig)
pander(summary(model2))
```

### Fin. strain * business age > Quit intention 

* moderation by business/ entrepreneurial characteristics 
* with control variables

```{r include = TRUE}
model2 <- lm(quit ~  exp_cond*t1timebuiss + finsit_1 + finsit_2 + age + gender + edu + coown, data = comp_df_vig)
pander(summary(model2))
```

```{r}
model2 <- lm(NA. ~  exp_cond + t1timebuiss + finsit_1 + finsit_2 + age + gender + edu, data = comp_df_vig)
pander(summary(model2))
model2 <- lm(PA ~  exp_cond + t1timebuiss + finsit_1 + finsit_2 + age + gender + edu, data = comp_df_vig)
pander(summary(model2))
model2 <- lm(satis ~  exp_cond + t1timebuiss + finsit_1 + finsit_2 + age + gender + edu, data = comp_df_vig)
pander(summary(model2))


model2 <- lm(quit ~  exp_cond + t1timebuiss + finsit_1 + finsit_2 + age + gender + edu, data = comp_df_vig)
pander(summary(model2))
```


